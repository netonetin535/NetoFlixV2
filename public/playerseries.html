<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Episódios</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body { margin: 0; background: #141414; color: #fff; font-family: Arial, sans-serif; overflow: hidden; }
    .player-container { position: relative; width: 100vw; height: 100vh; background: #000; }
    video { width: 100%; height: 100%; object-fit: contain; }
    .controls { position: absolute; bottom: 0; width: 100%; background: rgba(0, 0, 0, 0.7); padding: 10px; display: flex; align-items: center; justify-content: space-between; }
    .progress-container { position: absolute; bottom: 50px; width: 100%; height: 5px; background: #555; }
    .progress { height: 100%; background: #e50914; width: 0; }
    .btn { background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; margin: 0 10px; }
    .time { font-size: 14px; }
    .episode-list { position: absolute; top: 0; right: 0; width: 300px; background: #141414; height: 100vh; overflow-y: auto; padding: 20px; transform: translateX(100%); transition: transform 0.3s; }
    .episode-list.active { transform: translateX(0); }
    .episode-item { padding: 10px; cursor: pointer; }
    .episode-item:hover { background: #333; }
    .error-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #e50914; padding: 20px; border-radius: 5px; }
    .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; }
  </style>
</head>
<body>
  <div class="player-container">
    <a href="javascript:history.back()" class="btn"><i class="fas fa-arrow-left"></i> Voltar</a>
    <h1 id="title">Carregando título...</h1>
    <video id="player" controls></video>
    <div class="loading" id="loading">Carregando...</div>
    <div class="error-message" id="error" style="display: none;"></div>
    <div class="progress-container">
      <div class="progress" id="progress"></div>
    </div>
    <div class="controls">
      <button class="btn" id="playPauseBtn"><i class="fas fa-play"></i></button>
      <span class="time" id="currentTime">00:00</span>
      <span class="time" id="duration">--:--</span>
      <button class="btn" id="volumeBtn"><i class="fas fa-volume-up"></i></button>
      <button class="btn" id="originalSizeBtn"><i class="fas fa-compress"></i> Tamanho original</button>
      <button class="btn" id="fullscreenBtn"><i class="fas fa-expand"></i> Tela cheia</button>
      <select id="speedSelect" class="btn">
        <option value="0.5">0.5x</option>
        <option value="1" selected>1x</option>
        <option value="1.5">1.5x</option>
        <option value="2">2x</option>
      </select>
      <button class="btn" id="episodesBtn"><i class="fas fa-list"></i> Escolha um Episódio</button>
    </div>
    <div class="episode-list" id="episodeList">
      <button class="btn" id="closeEpisodeList"><i class="fas fa-times"></i> Fechar</button>
      <div id="episodeItems"></div>
    </div>
  </div>

  <script>
    const API_KEY = 'sua_chave_real_aqui'; // Substitua pela sua chave real da TMDb
    const CACHE_KEY = 'series_data';
    const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 horas
    const player = document.getElementById('player');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const volumeBtn = document.getElementById('volumeBtn');
    const originalSizeBtn = document.getElementById('originalSizeBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const speedSelect = document.getElementById('speedSelect');
    const progress = document.getElementById('progress');
    const currentTimeDisplay = document.getElementById('currentTime');
    const durationDisplay = document.getElementById('duration');
    const titleEl = document.getElementById('title');
    const loading = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const episodesBtn = document.getElementById('episodesBtn');
    const episodeList = document.getElementById('episodeList');
    const closeEpisodeList = document.getElementById('closeEpisodeList');
    const episodeItems = document.getElementById('episodeItems');
    const urlParams = new URLSearchParams(window.location.search);
    const streamId = urlParams.get('id');
    const tmdbId = urlParams.get('tmdb');
    let lastTime = parseFloat(localStorage.getItem(`pos_${streamId}`)) || 0;

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = Math.floor(seconds % 60);
      return `${min}:${sec < 10 ? '0' : ''}${sec}`;
    }

    function showError(message) {
      errorEl.innerText = message;
      errorEl.style.display = 'block';
      loading.style.display = 'none';
    }

    async function inicializarPlayer() {
      if (!streamId || !tmdbId) {
        showError("ID do episódio ou TMDb ausente na URL.");
        return;
      }

      try {
        const [serieTMDB, seriesLocal, cachedData] = await Promise.all([
          fetch(`https://api.themoviedb.org/3/tv/${tmdbId}?api_key=${API_KEY}&language=pt-BR`)
            .then(res => {
              if (!res.ok) throw new Error(`Erro TMDb: ${res.status} ${res.statusText}`);
              return res.json();
            }),
          fetch("series_only.json").then(res => {
            if (!res.ok) throw new Error(`Erro ao carregar series_only.json: ${res.status}`);
            return res.json();
          }),
          Promise.resolve(JSON.parse(localStorage.getItem(CACHE_KEY)))
        ]);

        const serieLocal = seriesLocal.find(s => s.tmdb_id == tmdbId);
        if (!serieLocal) throw new Error("Série não encontrada em series_only.json");

        let episodios = [];
        if (cachedData && cachedData.timestamp > Date.now() - CACHE_DURATION && Array.isArray(cachedData.episodios)) {
          episodios = cachedData.episodios.filter(ep => ep && typeof ep === 'object' && ep.series_id === Number(serieLocal.series_id));
          console.log("Usando cache para episódios:", episodios);
        }

        if (episodios.length === 0) {
          const response = await fetch(`https://episodios-24c25-default-rtdb.firebaseio.com/.json?orderBy="series_id"&equalTo=${serieLocal.series_id}`);
          const data = await response.json();
          console.log("Resposta bruta do Firebase:", JSON.stringify(data, null, 2));
          if (data && typeof data === 'object' && !data.hasOwnProperty('error')) {
            // Simplificar a extração dos episódios
            episodios = Object.values(data).filter(ep => ep.series_id === Number(serieLocal.series_id));
            console.log("Episódios extraídos:", episodios);
            if (episodios.length > 0) {
              localStorage.setItem(CACHE_KEY, JSON.stringify({ episodios, timestamp: Date.now() }));
              console.log("Episódios salvos no cache:", episodios);
            } else {
              console.warn("Nenhum episódio encontrado no Firebase para series_id:", serieLocal.series_id);
            }
          } else {
            console.warn("Erro ou dados inválidos na resposta do Firebase:", data);
          }
        }

        const episodio = episodios.find(e => String(e.id) === String(streamId));
        if (!episodio) throw new Error(`Episódio com id ${streamId} não encontrado.`);

        // Tentar capturar o URL redirecionado
        let videoUrl = `http://hsgbola1.xyz/series/879446467/771463126/${streamId}.mp4`;
        console.log("Tentando carregar vídeo de:", videoUrl);
        const response = await fetch(videoUrl, { method: 'HEAD', redirect: 'follow' });
        if (response.ok && response.url) {
          videoUrl = response.url; // Usa o URL redirecionado
          console.log("URL redirecionado:", videoUrl);
        }

        player.src = videoUrl;
        player.currentTime = lastTime;

        player.addEventListener("loadedmetadata", () => {
          console.log("Vídeo carregado de:", player.src);
          loading.style.display = "none";
          durationDisplay.innerText = formatTime(player.duration);
        });

        player.addEventListener("error", (e) => {
          console.error("Erro ao carregar vídeo:", e);
          const errorMsg = player.error ? `Código: ${player.error.code}, Mensagem: ${player.error.message}` : "Erro desconhecido";
          showError(`Não foi possível carregar o vídeo. ${errorMsg} Tente outro episódio.`);
        });

        player.addEventListener("timeupdate", () => {
          const percent = (player.currentTime / player.duration) * 100;
          progress.style.width = `${percent}%`;
          currentTimeDisplay.innerText = formatTime(player.currentTime);
          localStorage.setItem(`pos_${streamId}`, player.currentTime);
        });

        player.addEventListener("ended", () => {
          playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
          irParaProximoEpisodio(episodios, serieLocal.series_id);
        });

        // Atualizar título
        const title = episodio.title || "Episódio";
        const serieTitle = serieLocal.name || serieTMDB.name || "Série";
        document.title = `${serieTitle} - ${title}`;
        titleEl.innerText = `${serieTitle} - ${title}`;

        // Atualizar histórico
        const historicoSeries = JSON.parse(localStorage.getItem("historicoSeries")) || [];
        const serieData = { stream_id: streamId, tmdb_id: tmdbId, title: `${serieTitle} - ${title}`, poster_path: serieLocal.image || "https://via.placeholder.com/300x450?text=Sem+Capa", type: "serie" };
        const existingIndex = historicoSeries.findIndex(s => s.stream_id === streamId);
        if (existingIndex >= 0) historicoSeries[existingIndex] = serieData;
        else historicoSeries.push(serieData);
        localStorage.setItem("historicoSeries", JSON.stringify(historicoSeries));

        episodesBtn.addEventListener("click", () => abrirListaEpisodios(episodios, serieLocal.series_id));
      } catch (error) {
        console.error("Erro ao inicializar o player:", error);
        showError(`Erro ao carregar o episódio: ${error.message}. Tente novamente mais tarde.`);
      }
    }

    function abrirListaEpisodios(episodios, seriesId) {
      episodeItems.innerHTML = '';
      episodios.forEach(ep => {
        const div = document.createElement('div');
        div.className = 'episode-item';
        div.innerText = `${ep.season}x${ep.episode_num < 10 ? '0' : ''}${ep.episode_num} - ${ep.title}`;
        div.onclick = () => {
          window.location.href = `playerSeries.html?id=${ep.id}&tmdb=${tmdbId}`;
        };
        episodeItems.appendChild(div);
      });
      episodeList.classList.add('active');
    }

    closeEpisodeList.addEventListener('click', () => {
      episodeList.classList.remove('active');
    });

    playPauseBtn.addEventListener('click', () => {
      if (player.paused) {
        player.play();
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
      } else {
        player.pause();
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
      }
    });

    volumeBtn.addEventListener('click', () => {
      player.muted = !player.muted;
      volumeBtn.innerHTML = player.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
    });

    originalSizeBtn.addEventListener('click', () => {
      player.style.objectFit = player.style.objectFit === 'contain' ? 'fill' : 'contain';
      originalSizeBtn.innerHTML = player.style.objectFit === 'contain' ? '<i class="fas fa-compress"></i> Tamanho original' : '<i class="fas fa-expand"></i> Ajustar à tela';
    });

    fullscreenBtn.addEventListener('click', () => {
      if (!document.fullscreenElement) {
        player.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    });

    speedSelect.addEventListener('change', () => {
      player.playbackRate = parseFloat(speedSelect.value);
    });

    player.addEventListener('click', () => {
      if (player.paused) {
        player.play();
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
      } else {
        player.pause();
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
      }
    });

    function irParaProximoEpisodio(episodios, seriesId) {
      const currentIndex = episodios.findIndex(e => String(e.id) === String(streamId));
      if (currentIndex < episodios.length - 1) {
        const nextEp = episodios[currentIndex + 1];
        window.location.href = `playerSeries.html?id=${nextEp.id}&tmdb=${tmdbId}`;
      }
    }

    inicializarPlayer();
  </script>
</body>
</html>
